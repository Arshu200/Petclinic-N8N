pipeline {
  agent any

  stages {
    stage('Build') {
      steps {
        script {
          sh '''
            chmod +x mvnw
            ./mvnw clean package
          '''
        }
      }
    }

    stage('Containerization') {
      steps {
        script {
          sh """
            docker build -t spring-petclinic:${env.BUILD_NUMBER} .
          """
        }
      }
    }

    // Uncomment and configure this stage if Slack notifications are needed
    // stage('Slack Notification') {
    //   steps {
    //     script {
    //       slackSend channel: '#test-internal',
    //         color: 'good',
    //         message: "The pipeline ${env.JOB_NAME} with build number ${env.BUILD_NUMBER} has been completed successfully."
    //     }
    //   }
    // }
  }

  post {
    failure {
      script {
        try {
          echo "Pipeline failed. Preparing to send logs to n8n..."
  
          def log = currentBuild.rawBuild.getLog(Integer.MAX_VALUE)
          def logString = log.join("\n")
          writeFile file: 'pipeline.log', text: logString
  
          def response = httpRequest(
            httpMode: 'POST',
            url: "https://clops.app.n8n.cloud/webhook/cd51c894-e55e-40ee-b674-eb1839605b78",
            contentType: 'MULTIPART_FORM_DATA',
            multipartName: 'file',
            uploadFile: 'pipeline.log'
          )
  
          echo "Webhook response: ${response.status} - ${response.content}"
        } catch (Exception e) {
          echo "ERROR sending webhook: ${e.message}"
        }
      }
    }
  }
}
